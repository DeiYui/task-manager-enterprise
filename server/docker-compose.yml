version: '3.8'

services:
  # 1. D·ªãch v·ª• Database (Gi·ªØ nguy√™n c·ªßa anh)
  postgres:
    image: postgres:15-alpine
    container_name: task_manager_db
    restart: always
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: myuser         # üëà User c≈© c·ªßa anh
      POSTGRES_PASSWORD: mypassword # üëà Pass c≈© c·ªßa anh
      POSTGRES_DB: task_manager_db  # üëà T√™n DB c≈©
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 2. Adminer (Gi·ªØ nguy√™n)
  adminer:
    image: adminer
    restart: always
    ports:
      - '8080:8080'

  # 3. Backend API (üî• TH√äM M·ªöI - "Ng√¥i sao" c·ªßa ch√∫ng ta)
  api:
    build: .                        # Build t·ª´ Dockerfile ·ªü th∆∞ m·ª•c hi·ªán t·∫°i
    container_name: task_manager_api
    restart: always
    ports:
      - "3000:3000"                 # M·ªü c·ªïng 3000 ra m√°y ngo√†i
    depends_on:
      - postgres                    # B·∫Øt bu·ªôc ch·ªù √¥ng Database ch·∫°y tr∆∞·ªõc
    env_file:
      - .env                        # ƒê·ªçc c√°c bi·∫øn kh√°c (JWT_SECRET...) t·ª´ file .env
    environment:
      # üî• QUAN TR·ªåNG NH·∫§T: Ghi ƒë√® DATABASE_URL
      # Trong th·∫ø gi·ªõi Docker:
      # - "localhost" l√† ch√≠nh c√°i h·ªôp API n√†y -> Sai.
      # - Mu·ªën g·ªçi Database, ph·∫£i g·ªçi t√™n service l√† "postgres".
      # - Credential ph·∫£i kh·ªõp v·ªõi ph·∫ßn environment c·ªßa service postgres ·ªü tr√™n.
      - DATABASE_URL=postgresql://myuser:mypassword@postgres:5432/task_manager_db?schema=public

volumes:
  postgres_data: